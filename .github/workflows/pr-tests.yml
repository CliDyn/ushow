name: PR Tests

on:
  pull_request:
    types:
      - opened
      - reopened
      - synchronize
      - ready_for_review

permissions:
  contents: read

jobs:
  test:
    name: Build (${{ matrix.name }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: default
            make_flags: ""
            run_tests: "true"
          - name: zarr-only
            make_flags: "WITH_ZARR=1"
            run_tests: "false"
          - name: grib-only
            make_flags: "WITH_GRIB=1"
            run_tests: "false"
          - name: zarr-and-grib
            make_flags: "WITH_ZARR=1 WITH_GRIB=1"
            run_tests: "false"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libnetcdf-dev \
            libblosc-dev \
            liblz4-dev \
            libeccodes-dev \
            libx11-dev \
            libxt-dev \
            libxaw7-dev \
            libxmu-dev \
            libxext-dev \
            libxpm-dev \
            pkg-config

      - name: Build
        run: |
          make clean
          make ${{ matrix.make_flags }} -j"$(nproc)"

      - name: Run tests
        if: matrix.run_tests == 'true'
        run: make ${{ matrix.make_flags }} test
